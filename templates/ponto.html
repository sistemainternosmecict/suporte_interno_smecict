{% extends "menu_interno.html" %}

{% block title %} Registro de Ponto {% endblock %}
{% block title_inline %} Registro de Ponto {% endblock %}

{% block content %}
<section>
    <div class="form-container">
        <h2>Cadastrar Novo Usuário</h2>
        <form id="form-cadastro-usuario">
            <label for="nome-usuario">Nome Completo</label>
            <input type="text" id="nome-usuario" name="nome" placeholder="Nome do Funcionário" required>
            <button type="submit">Cadastrar</button>
        </form>
    </div>

    <div class="form-container">
        <h2>Registrar Ponto</h2>
        <form id="form-registrar-ponto">
            <label for="select-usuario-ponto">Selecione o Usuário</label>
            <select id="select-usuario-ponto" name="usuario_id" required>
                <option value="">-- Selecione --</option>
                {% for user in usuarios %}
                    <option value="{{ user.id }}">{{ user.nome }}</option>
                {% endfor %}
            </select>
            <div class="ponto-actions">
                <button type="button" data-action="chegada" class="btn-ponto">Chegada</button>
                <button type="button" data-action="saida_almoco" class="btn-ponto">Saída Almoço</button>
                <button type="button" data-action="retorno_almoco" class="btn-ponto">Retorno Almoço</button>
                <button type="button" data-action="saida" class="btn-ponto">Saída</button>
            </div>
            <div id="ponto-hoje" class="ponto-display">
                <h3>Registros de Hoje:</h3>
                <p><strong>Chegada:</strong> <span id="chegada-hoje">--:--</span></p>
                <p><strong>Saída Almoço:</strong> <span id="saida-almoco-hoje">--:--</span></p>
                <p><strong>Retorno Almoço:</strong> <span id="retorno-almoco-hoje">--:--</span></p>
                <p><strong>Saída:</strong> <span id="saida-hoje">--:--</span></p>
            </div>
        </form>
    </div>

    <div class="form-container">
        <h2>Gerar Relatório Mensal</h2>
        <form id="form-gerar-relatorio">
            <label for="select-usuario-relatorio">Selecione o Usuário</label>
            <select id="select-usuario-relatorio" name="usuario_id" required>
                <option value="">-- Selecione --</option>
                {% for user in usuarios %}
                    <option value="{{ user.id }}">{{ user.nome }}</option>
                {% endfor %}
            </select>
            <label for="mes-relatorio">Mês</label>
            <input type="number" id="mes-relatorio" name="mes" min="1" max="12" value="{{ now.month }}" required>
            <label for="ano-relatorio">Ano</label>
            <input type="number" id="ano-relatorio" name="ano" min="2000" value="{{ now.year }}" required>
            <button type="submit">Gerar PDF</button>
        </form>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const formCadastroUsuario = document.getElementById('form-cadastro-usuario');
    const selectUsuarioPonto = document.getElementById('select-usuario-ponto');
    const selectUsuarioRelatorio = document.getElementById('select-usuario-relatorio');
    const pontoActionButtons = document.querySelectorAll('.btn-ponto');
    const formRegistrarPonto = document.getElementById('form-registrar-ponto');
    const formGerarRelatorio = document.getElementById('form-gerar-relatorio');
    const prefix = "{{ '/suporte' if mode == 'prod' else '' }}";

    const updatePontoDisplay = (registros) => {
        document.getElementById('chegada-hoje').textContent = registros.chegada || '--:--';
        document.getElementById('saida-almoco-hoje').textContent = registros.saida_almoco || '--:--';
        document.getElementById('retorno-almoco-hoje').textContent = registros.retorno_almoco || '--:--';
        document.getElementById('saida-hoje').textContent = registros.saida || '--:--';
        
        // Disable/enable buttons based on current state
        pontoActionButtons.forEach(button => {
            const action = button.dataset.action;
            if (registros[action]) {
                button.disabled = true;
            } else {
                button.disabled = false;
            }
        });
        // Logic to enable buttons sequentially
        if (registros.chegada && !registros.saida_almoco) {
            document.querySelector('[data-action="saida_almoco"]').disabled = false;
        } else if (registros.saida_almoco && !registros.retorno_almoco) {
            document.querySelector('[data-action="retorno_almoco"]').disabled = false;
        } else if (registros.retorno_almoco && !registros.saida) {
            document.querySelector('[data-action="saida"]').disabled = false;
        }
    };

    const fetchCurrentPonto = async (usuarioId) => {
        if (!usuarioId) {
            updatePontoDisplay({}); // Clear display if no user selected
            return;
        }
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`${prefix}/ponto/registros_dia?usuario_id=${usuarioId}&data=${today}`);
        if (response.ok) {
            const data = await response.json();
            updatePontoDisplay(data.registros || {});
        } else {
            console.error('Erro ao buscar registros de hoje.');
            updatePontoDisplay({});
        }
    };

    // Initial load for point registration form
    selectUsuarioPonto.addEventListener('change', (e) => {
        fetchCurrentPonto(e.target.value);
    });

    // Handle user registration
    formCadastroUsuario.addEventListener('submit', async (e) => {
        e.preventDefault();
        const prefix = "{{ '/suporte' if mode == 'prod' else '' }}";
        const nome = document.getElementById('nome-usuario').value;
        const response = await fetch(`${prefix}/ponto/cadastrar_usuario`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nome: nome })
        });
        const data = await response.json();
        if (data.success) {
            alert('Usuário cadastrado com sucesso!');
            document.getElementById('nome-usuario').value = '';
            // Refresh user lists
            location.reload(); // Simple reload for now
        } else {
            alert('Erro ao cadastrar usuário: ' + (data.error || 'Desconhecido'));
        }
    });

    // Handle point registration
    pontoActionButtons.forEach(button => {
        button.addEventListener('click', async () => {
            const prefix = "{{ '/suporte' if mode == 'prod' else '' }}";
            const usuarioId = selectUsuarioPonto.value;
            if (!usuarioId) {
                alert('Por favor, selecione um usuário.');
                return;
            }
            const action = button.dataset.action;
            const response = await fetch(`${prefix}/ponto/registrar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario_id: usuarioId, action: action })
            });
            const data = await response.json();
            if (data.success) {
                alert('Ponto registrado com sucesso!');
                fetchCurrentPonto(usuarioId); // Refresh display
            } else {
                alert('Erro ao registrar ponto: ' + (data.error || 'Desconhecido'));
            }
        });
    });

    // Handle report generation
    formGerarRelatorio.addEventListener('submit', async (e) => {
        e.preventDefault();
        const usuarioId = selectUsuarioRelatorio.value;
        const mes = document.getElementById('mes-relatorio').value;
        const ano = document.getElementById('ano-relatorio').value;

        if (!usuarioId || !mes || !ano) {
            alert('Por favor, selecione um usuário, mês e ano.');
            return;
        }

        const prefix = "{{ '/suporte' if mode == 'prod' else '' }}";
        const reportUrl = `${prefix}/ponto/gerar_pdf`;

        // Using a regular form submission for PDF download
        const tempForm = document.createElement('form');
        tempForm.action = reportUrl;
        tempForm.method = 'POST';
        tempForm.target = '_blank'; // Open in new tab

        const inputUsuarioId = document.createElement('input');
        inputUsuarioId.type = 'hidden';
        inputUsuarioId.name = 'usuario_id';
        inputUsuarioId.value = usuarioId;
        tempForm.appendChild(inputUsuarioId);

        const inputMes = document.createElement('input');
        inputMes.type = 'hidden';
        inputMes.name = 'mes';
        inputMes.value = mes;
        tempForm.appendChild(inputMes);

        const inputAno = document.createElement('input');
        inputAno.type = 'hidden';
        inputAno.name = 'ano';
        inputAno.value = ano;
        tempForm.appendChild(inputAno);

        document.body.appendChild(tempForm);
        tempForm.submit();
        document.body.removeChild(tempForm);
    });

    // Fetch and display initial ponto for the first user in the list, if any
    if (selectUsuarioPonto.value) {
        fetchCurrentPonto(selectUsuarioPonto.value);
    }
});
</script>

<style>
    section {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        padding: 24px;
        justify-content: center;
        box-sizing: border-box;
    }

    .form-container {
        flex-basis: 350px; /* Adjust width as needed */
        max-width: 400px;
        background: var(--background-color);
        border-radius: 8px;
        box-shadow: 0 4px 8px var(--shadow-color);
        padding: 24px;
        box-sizing: border-box;
    }

    .form-container h2 {
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 20px;
        text-align: center;
        border-bottom: 2px solid var(--secondary-color);
        padding-bottom: 10px;
    }

    form label {
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--text-color);
        display: block;
    }

    form input[type="text"],
    form input[type="number"],
    form select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
        margin-bottom: 10px;
    }

    form button[type="submit"] {
        width: 100%;
        padding: 10px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-top: 15px;
    }

    form button[type="submit"]:hover {
        background-color: var(--primary-color-dark);
    }

    .ponto-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .btn-ponto {
        padding: 12px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-ponto:hover:not(:disabled) {
        background-color: var(--primary-color-dark);
    }

    .btn-ponto:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    .ponto-display {
        background-color: var(--secondary-color);
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
    }

    .ponto-display h3 {
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 10px;
    }

    .ponto-display p {
        margin: 5px 0;
    }
</style>
{% endblock %}
